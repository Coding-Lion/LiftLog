@using System.Globalization


@{
    var firstDayOfMonth = new DateOnly(_currentYear, _currentMonth, 1);
    var firstDayOfWeek = (int)firstDayOfMonth.DayOfWeek;
    var lastDayOfPreviousMonth = firstDayOfMonth.AddDays(-1);
    var index = 0;
}
<div class="grid grid-cols-7 gap-2">
    <div class="col-span-1 my-2">
        <IconButton Type=IconButtonType.Standard @onclick="PreviousMonth" Icon="chevron_left" />
    </div>
    <div class="col-span-5 flex my-2 justify-center items-center">
        <h2>@DateTimeFormatInfo.CurrentInfo.GetMonthName(_currentMonth) @_currentYear</h2>
    </div>
    <div class="col-span-1 my-2 text-right">
        <IconButton Type=IconButtonType.Standard @onclick="NextMonth" disabled=@DisableNext Icon="chevron_right" />
    </div>

    <span class="mb-2">@(DateTimeFormatInfo.CurrentInfo.GetShortestDayName(DayOfWeek.Sunday))</span>
    <span>@(DateTimeFormatInfo.CurrentInfo.GetShortestDayName(DayOfWeek.Monday))</span>
    <span>@(DateTimeFormatInfo.CurrentInfo.GetShortestDayName(DayOfWeek.Tuesday))</span>
    <span>@(DateTimeFormatInfo.CurrentInfo.GetShortestDayName(DayOfWeek.Wednesday))</span>
    <span>@(DateTimeFormatInfo.CurrentInfo.GetShortestDayName(DayOfWeek.Thursday))</span>
    <span>@(DateTimeFormatInfo.CurrentInfo.GetShortestDayName(DayOfWeek.Friday))</span>
    <span>@(DateTimeFormatInfo.CurrentInfo.GetShortestDayName(DayOfWeek.Saturday))</span>
    @for (int i = 0; i < firstDayOfWeek; i++)
    {
        @RenderDay(lastDayOfPreviousMonth.AddDays(-i), index++)
    }
    @for (int i = 1; i <= DateTime.DaysInMonth(_currentYear, _currentMonth); i++)
    {
        var date = new DateOnly(_currentYear, _currentMonth, i);

        @RenderDay(date, index++)
    }

</div>

@code {
    private int _currentMonth = DateTime.Now.Month;
    private int _currentYear = DateTime.Now.Year;

    private ILookup<DateOnly, Session> _sessionsByDate = null!;

    private bool DisableNext => _currentYear == DateTime.Now.Year && _currentMonth == DateTime.Now.Month;

    [Parameter]
    [EditorRequired]
    public IReadOnlyList<Session> Sessions { get; set; } = [];

    [Parameter]
    [EditorRequired]
    public EventCallback<Session> OnSessionClick { get; set; }

    [Parameter]
    [EditorRequired]
    public EventCallback<Session> OnSessionLongPress { get; set; }

    [Parameter]
    public EventCallback<DateOnly> OnDateSelect { get; set; }

    [Parameter]
    public EventCallback<DateOnly> OnMonthChange { get; set; }

    protected override void OnParametersSet()
    {
        base.OnParametersSet();
        _sessionsByDate = Sessions.ToLookup(s => s.Date);
    }

    private void NextMonth()
    {
        if(DisableNext){
            return;
        }
        if (_currentMonth == 12)
        {
            _currentMonth = 1;
            _currentYear++;
        }
        else
        {
            _currentMonth++;
        }
        OnMonthChange.InvokeAsync(new DateOnly(_currentYear, _currentMonth, 1));
    }

    private void PreviousMonth()
    {
        if (_currentMonth == 1)
        {
            _currentMonth = 12;
            _currentYear--;
        }
        else
        {
            _currentMonth--;
        }

        OnMonthChange.InvokeAsync(new DateOnly(_currentYear, _currentMonth, 1));
    }

    private void GoToToday()
    {
        _currentMonth = DateTime.Now.Month;
        _currentYear = DateTime.Now.Year;
    }

    private RenderFragment RenderDay(DateOnly date, int index)
    {
        var sessions = _sessionsByDate[date];
        var hasSessions = sessions.Any();
        var isToday = date == DateOnly.FromDateTime(DateTime.Today);

        var hasSessionsButtonClass = hasSessions ? "text-on-primary" : "";
        var hasSessionsPillClass = hasSessions ? "bg-primary rounded-full text-on-primary " : "";
        var isTodayClass = isToday ? "border-primary border border-solid rounded-full text-primary" : "";
        var delay = index * 10 + "ms";

        return
            @<div style="animation-delay: @delay;" class=" scale-0 animate-zoom-in justify-center items-center grid grid-rows-1 grid-cols-1" @key=date>
                <div  class="@hasSessionsPillClass @isTodayClass relative col-start-1 col-end-1 row-start-1 row-end-1 w-12 aspect-square">
                    @if(hasSessions)
                    {
                        <md-ripple></md-ripple>
                    }
                </div>
                <button @oncontextmenu:preventDefault=true @oncontextmenu=@(()=>HandleDayLongPress(date)) @onclick=@(()=>HandleDayClick(date)) class="@hasSessionsButtonClass @isTodayClass flex col-start-1 col-end-1 row-start-1 row-end-1 items-center justify-center w-12 aspect-square relative" >
                    @date.Day
                </button>

            </div>;
    }

    private async Task HandleDayLongPress(DateOnly date)
    {
        var sessions = _sessionsByDate[date];
        if (sessions.Any())
        {
            await OnSessionLongPress.InvokeAsync(sessions.First());
        }
    }

    private async Task HandleDayClick(DateOnly date)
    {
        var sessions = _sessionsByDate[date];
        if (sessions.Any())
        {
            await OnSessionClick.InvokeAsync(sessions.First());
        }else{
            await OnDateSelect.InvokeAsync(date);
        }
    }

}
